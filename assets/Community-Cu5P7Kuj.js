import{_ as Z,r as m,x as ss,c as g,A as j,a as n,b as s,i as I,w as V,s as ts,F as d,f as r,u as N,h as k,j as E,v as z,k as ls,t as o,g as es,e as as,o as a,n as A,d as M}from"./index-BlCAvboD.js";import{S as os,C as ns}from"./CreatorCard-BqXQ0-9H.js";import{b as is,c as us}from"./demo-D30EAGrZ.js";import{t as O,g as ds,e as rs}from"./community-C-1U7jpS.js";const cs={class:"page"},vs={class:"page-header"},ms={key:1,class:"primary-button"},ps={class:"community-layout"},ys={class:"community-main"},_s={class:"community-stats"},gs={class:"stat-value"},fs={class:"stat-label"},bs={class:"story-grid"},hs={class:"topic-filter"},ks={class:"filter-row"},Ss={class:"filter-chips"},xs=["onClick"],Cs={class:"topic-grid"},Ts=["src","alt"],Ns={class:"topic-tags"},ws={key:0,class:"topic-empty"},Js={class:"gallery-block"},Is={class:"gallery-grid"},Vs=["src","alt"],Es={key:0,class:"detail-card"},Os={class:"detail-head"},Bs={class:"detail-actions"},Ds={class:"detail-stats"},Ls={class:"detail-body"},Rs={class:"detail-block"},js={class:"detail-block"},zs={class:"detail-block"},As={class:"comment-list"},Ms={class:"detail-input"},Us={class:"comment-actions"},$s={class:"submit-hint"},Fs=["disabled"],qs={key:1,class:"detail-empty"},Hs={class:"community-side"},Ks={class:"side-card"},Qs={class:"side-card"},Gs={key:0,class:"muted"},Ps={key:1,class:"topic-list"},Ws={class:"side-card"},Xs={class:"rank-list"},Ys={class:"rank-index"},Zs={class:"side-card"},st={class:"creator-grid"},tt={__name:"Community",setup(lt){const p=m(O),w=m(""),S=m("全部"),b=m("活跃"),y=m(O[0]?.id||""),_=m([]),U=m(null),x=m(""),f=m(""),c=m([]),{state:B}=ss(),C=g(()=>!B.user),$=g(()=>{const e=new Set;return p.value.forEach(t=>t.tags.forEach(i=>e.add(i))),["全部",...Array.from(e)]}),h=g(()=>{const e={};return p.value.forEach(t=>{const i=_.value.includes(t.id)?1:0;e[t.id]={...t.stats,members:t.stats.members+i,today:t.stats.today+i}}),e}),J=g(()=>v.value?h.value[v.value.id]||v.value.stats:null),D=g(()=>{const e=w.value.trim();let t=p.value.filter(i=>{const l=S.value==="全部"||i.tags.includes(S.value),u=!e||i.title.includes(e)||i.desc.includes(e);return l&&u});return b.value==="活跃"?t=[...t].sort((i,l)=>l.stats.today-i.stats.today):b.value==="参与人数"?t=[...t].sort((i,l)=>h.value[l.id].members-h.value[i.id].members):b.value==="声音数"&&(t=[...t].sort((i,l)=>l.stats.sounds-i.stats.sounds)),t}),F=g(()=>{const e=p.value.reduce((l,u)=>l+h.value[u.id].members,0),t=p.value.reduce((l,u)=>l+u.stats.today,0),i=p.value.reduce((l,u)=>l+u.stats.sounds,0);return[{label:"社区成员",value:e},{label:"今日新增",value:t},{label:"声音累计",value:i}]}),q=g(()=>[...p.value].sort((e,t)=>t.stats.today-e.stats.today).slice(0,3)),v=g(()=>p.value.find(e=>e.id===y.value)||null),L=g(()=>_.value.includes(y.value)),R=g(()=>c.value.includes(y.value)),H=()=>{y.value&&(L.value?_.value=_.value.filter(e=>e!==y.value):_.value=[..._.value,y.value])},K=()=>{if(C.value){f.value="请先登录后收藏话题。";return}y.value&&(R.value?c.value=c.value.filter(e=>e!==y.value):c.value=[...c.value,y.value])},Q=()=>{if(C.value){f.value="请先登录后再提交。";return}if(!v.value)return;const e=x.value.trim();if(!e){f.value="请输入评论内容。";return}v.value.discussions.unshift({name:B.user?.name||"我",time:"刚刚",text:e}),x.value="",f.value="已提交",Y(),setTimeout(()=>{f.value=""},2e3)},G=()=>{try{_.value=JSON.parse(localStorage.getItem("csm_joined_topics")||"[]"),c.value=JSON.parse(localStorage.getItem("csm_saved_topics")||"[]")}catch{_.value=[],c.value=[]}},P=()=>{localStorage.setItem("csm_joined_topics",JSON.stringify(_.value))},W=()=>{localStorage.setItem("csm_saved_topics",JSON.stringify(c.value))};G(),j(_,P,{deep:!0}),j(c,W,{deep:!0});const T=m({}),X=()=>{try{const e=JSON.parse(localStorage.getItem("csm_topic_discussions")||"{}");T.value=e||{}}catch{T.value={}}O.forEach(e=>{T.value[e.id]&&(e.discussions=T.value[e.id])})},Y=()=>{const e={};p.value.forEach(t=>{e[t.id]=t.discussions}),localStorage.setItem("csm_topic_discussions",JSON.stringify(e))};return X(),(e,t)=>{const i=as("RouterLink");return a(),n("div",cs,[s("header",vs,[t[4]||(t[4]=s("div",null,[s("h1",null,"社区与共创"),s("p",null,"与城市记录者一起，共同完善这张声音地图。")],-1)),C.value?(a(),I(i,{key:0,class:"primary-button",to:"/login"},{default:V(()=>[...t[3]||(t[3]=[k("登录后发布",-1)])]),_:1})):(a(),n("button",ms,"发布话题"))]),s("section",ps,[s("div",ys,[s("div",_s,[(a(!0),n(d,null,r(F.value,l=>(a(),n("div",{key:l.label,class:"stat-card"},[s("p",gs,o(l.value),1),s("p",fs,o(l.label),1)]))),128))]),t[20]||(t[20]=s("div",{class:"section-head"},[s("div",null,[s("h2",null,"精选故事"),s("p",null,"来自创作者的声音故事与灵感。")])],-1)),s("div",bs,[(a(!0),n(d,null,r(N(is),l=>(a(),I(os,{key:l.name,story:l},null,8,["story"]))),128))]),t[21]||(t[21]=s("div",{class:"section-head"},[s("div",null,[s("h2",null,"热门话题"),s("p",null,"参与讨论，贡献你的声音视角。")])],-1)),s("div",hs,[s("label",null,[t[5]||(t[5]=k(" 搜索话题 ",-1)),E(s("input",{"onUpdate:modelValue":t[0]||(t[0]=l=>w.value=l),type:"text",placeholder:"输入关键字"},null,512),[[z,w.value]])]),s("div",ks,[t[6]||(t[6]=s("span",null,"标签",-1)),s("div",Ss,[(a(!0),n(d,null,r($.value,l=>(a(),n("button",{key:l,class:A(["chip",{active:S.value===l}]),onClick:u=>S.value=l},o(l),11,xs))),128))])]),s("label",null,[t[8]||(t[8]=k(" 排序 ",-1)),E(s("select",{"onUpdate:modelValue":t[1]||(t[1]=l=>b.value=l)},[...t[7]||(t[7]=[s("option",null,"活跃",-1),s("option",null,"参与人数",-1),s("option",null,"声音数",-1)])],512),[[ls,b.value]])])]),s("div",Cs,[(a(!0),n(d,null,r(D.value,l=>(a(),n("article",{key:l.id,class:A(["topic-card",{active:y.value===l.id}])},[s("img",{class:"topic-image",src:l.image,alt:l.title,loading:"lazy",decoding:"async"},null,8,Ts),s("h3",null,o(l.title),1),s("p",null,o(l.desc),1),s("div",Ns,[(a(!0),n(d,null,r(l.tags,u=>(a(),n("span",{key:u},o(u),1))),128))]),M(i,{class:"text-button",to:`/community/topics/${l.id}`},{default:V(()=>[...t[9]||(t[9]=[k(" 查看话题 ",-1)])]),_:1},8,["to"])],2))),128))]),D.value.length?ts("",!0):(a(),n("div",ws,[...t[10]||(t[10]=[s("p",null,"没有匹配的话题，请调整筛选条件。",-1)])])),s("div",Js,[t[11]||(t[11]=s("div",{class:"section-head"},[s("div",null,[s("h2",null,"社区图集"),s("p",null,"记录采集瞬间与现场氛围。")])],-1)),s("div",Is,[(a(!0),n(d,null,r(N(ds),l=>(a(),n("article",{key:l.title,class:"gallery-card"},[s("img",{src:l.image,alt:l.title,loading:"lazy",decoding:"async"},null,8,Vs),s("div",null,[s("h4",null,o(l.title),1),s("p",null,o(l.meta),1)])]))),128))])]),s("section",{ref_key:"detailRef",ref:U,class:"topic-detail"},[v.value?(a(),n("div",Es,[s("div",Os,[s("div",null,[s("h3",null,o(v.value.title),1),s("p",null,o(v.value.desc),1)]),s("div",Bs,[s("button",{class:"ghost-button",onClick:K},o(R.value?"已收藏":"收藏话题"),1),s("button",{class:"primary-button",onClick:H},o(L.value?"已加入":"参与话题"),1)])]),s("div",Ds,[s("div",null,[s("strong",null,o(J.value?.members),1),t[12]||(t[12]=s("span",null,"参与者",-1))]),s("div",null,[s("strong",null,o(J.value?.today),1),t[13]||(t[13]=s("span",null,"今日新增",-1))]),s("div",null,[s("strong",null,o(J.value?.sounds),1),t[14]||(t[14]=s("span",null,"声音数量",-1))])]),s("div",Ls,[s("div",Rs,[t[15]||(t[15]=s("h4",null,"采集建议",-1)),s("p",null,o(v.value.guideline),1)]),s("div",js,[t[16]||(t[16]=s("h4",null,"最新动态",-1)),s("ul",null,[(a(!0),n(d,null,r(v.value.updates,l=>(a(),n("li",{key:l.title+l.time},[s("span",null,o(l.title),1),s("small",null,o(l.author)+" · "+o(l.time),1)]))),128))])])]),s("div",zs,[t[17]||(t[17]=s("h4",null,"最新评论",-1)),s("ul",As,[(a(!0),n(d,null,r(v.value.discussions,l=>(a(),n("li",{key:l.name+l.time+l.text},[s("strong",null,o(l.name),1),s("small",null,o(l.time),1),s("p",null,o(l.text),1)]))),128))])]),s("div",Ms,[t[18]||(t[18]=s("h4",null,"发布讨论",-1)),E(s("textarea",{"onUpdate:modelValue":t[2]||(t[2]=l=>x.value=l),rows:"3",placeholder:"分享你的声音线索或采集心得"},null,512),[[z,x.value]]),s("div",Us,[s("span",$s,o(f.value),1),s("button",{class:"ghost-button",disabled:C.value,onClick:Q}," 提交讨论 ",8,Fs)])])])):(a(),n("div",qs,[...t[19]||(t[19]=[s("p",null,"请选择一个话题查看详情。",-1)])]))],512)]),s("aside",Hs,[s("div",Ks,[t[22]||(t[22]=s("h3",null,"本月活动",-1)),s("ul",null,[(a(!0),n(d,null,r(N(rs),l=>(a(),n("li",{key:l.title},[s("span",null,o(l.date),1),s("strong",null,o(l.title),1)]))),128))])]),s("div",Qs,[t[23]||(t[23]=s("h3",null,"我的话题",-1)),c.value.length?(a(),n("ul",Ps,[(a(!0),n(d,null,r(c.value,l=>(a(),n("li",{key:l},[M(i,{class:"text-button",to:`/community/topics/${l}`},{default:V(()=>[k(o(p.value.find(u=>u.id===l)?.title),1)]),_:2},1032,["to"])]))),128))])):(a(),n("p",Gs,"暂无收藏话题"))]),s("div",Ws,[t[24]||(t[24]=s("h3",null,"话题榜单",-1)),s("ol",Xs,[(a(!0),n(d,null,r(q.value,(l,u)=>(a(),n("li",{key:l.id},[s("span",Ys,o(u+1),1),s("div",null,[s("strong",null,o(l.title),1),s("p",null,o(l.stats.today)+" 今日新增 · "+o(h.value[l.id].members)+" 人参与 ",1)])]))),128))])]),t[26]||(t[26]=es('<div class="side-card goal-card" data-v-fe135d5c><h3 data-v-fe135d5c>本周目标</h3><p data-v-fe135d5c>收集 60 条新声音</p><div class="goal-progress" data-v-fe135d5c><span style="width:68%;" data-v-fe135d5c></span></div><p class="goal-meta" data-v-fe135d5c>已完成 41/60</p><button class="ghost-button" data-v-fe135d5c>参与挑战</button></div>',1)),s("div",Zs,[t[25]||(t[25]=s("h3",null,"推荐创作者",-1)),s("div",st,[(a(!0),n(d,null,r(N(us),l=>(a(),I(ns,{key:l.name,creator:l},null,8,["creator"]))),128))])])])])])}}},it=Z(tt,[["__scopeId","data-v-fe135d5c"]]);export{it as default};
